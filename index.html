<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location Tracking</title>
    <style>
        body {
            text-align: center;
        }
        #floor-map {
            width: 90%;
            height: 400px;
            background-color: lightgray;
            position: relative;
            margin: 20px auto;
            overflow: hidden;
        }
        #user-dot {
            width: 20px;
            height: 20px;
            background-color: blue;
            border-radius: 50%;
            position: absolute;
            top: 100px;
            left: 100px;
            transition: all 0.2s ease-in-out;
        }
        #start-btn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h2>Live Location Tracking on Floor Map</h2>
    <button id="start-btn">Start Tracking</button>
    <div id="floor-map">
        <div id="user-dot"></div>
    </div>
    <div id="messages"></div>

    <script>
        let position = { x: 100, y: 100 }; // Initial user position
        const STEP_SIZE = 10; // Pixels per step
        let currentHeading = 0; // Store the latest heading

        document.getElementById("start-btn").addEventListener("click", requestPermissions);

        async function requestPermissions() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    let response = await DeviceMotionEvent.requestPermission();
                    if (response === 'granted') {
                        startTracking();
                    }
                } catch (e) {
                    console.error("Permission request failed", e);
                }
            } else {
                startTracking(); // For non-iOS devices
            }
        }

        function startTracking() {
            // Listen for compass direction
            window.addEventListener("deviceorientation", (event) => {
                currentHeading = event.alpha; // Store heading globally
            });

            // Detect steps (movement)
            let prevAcceleration = 0;
            window.addEventListener("devicemotion", (event) => {
                let acc = event.acceleration;
                let acceleration = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
                document.getElementById('messages').innerHTML+= `<br> Accelration: ${acceleration}, PrevAcceleration: ${prevAcceleration}`
                if (Math.abs(acceleration - prevAcceleration) > 2) { // Step detection threshold
                    document.getElementById('messages').innerHTML+= `<br> Moving user`;
                    moveUser(currentHeading);
                }

                prevAcceleration = acceleration;
            });
        }

        function getDirection(heading) {
            if ((heading >= 315 && heading <= 360) || (heading >= 0 && heading < 45)) return "North";
            if (heading >= 45 && heading < 135) return "East";
            if (heading >= 135 && heading < 225) return "South";
            if (heading >= 225 && heading < 315) return "West";
        }

        function moveUser(heading) {
            let direction = getDirection(heading);

            if (direction === "North") position.y -= STEP_SIZE;
            if (direction === "South") position.y += STEP_SIZE;
            if (direction === "East") position.x += STEP_SIZE;
            if (direction === "West") position.x -= STEP_SIZE;

            document.getElementById('messages').innerHTML += `<br>Position: (${position.x}, ${position.y})`;
            document.getElementById("user-dot").style.transform = `translate(${position.x}px, ${position.y}px)`;
        }
    </script>

</body>
</html>
